## Context

当前 GitHub 仓库下载器脚本在 GitHub 代码页面显示一个固定的控制按钮（📦），位于页面右下角（position: fixed; right: 20px; bottom: 30px）。该按钮用于打开/关闭文件下载控制面板。用户反馈该固定位置在某些情况下会造成视觉干扰，且无法根据页面布局或个人偏好进行调整。

本设计基于《Button Smart Interaction Upgrade Design.md》文档，实现一套完整的按钮交互系统，包括拖拽移动、边缘吸附、自动隐藏、智能面板定位等功能。

**当前状态：**
- 按钮使用固定 CSS 定位，无法移动
- 控制面板固定在按钮上方固定位置
- 无状态持久化机制
- 无用户自定义选项

**约束条件：**
- 必须兼容 Tampermonkey 用户脚本环境
- 使用纯 JavaScript (ES5+) 实现，无需构建工具
- 依赖 GM_setValue/GM_getValue/GM_registerMenuCommand API
- 保持与现有代码结构和风格的兼容性
- 不影响现有下载功能的核心逻辑

## Goals / Non-Goals

**Goals:**
1. 实现按钮拖拽移动功能，支持边界限制和拖拽/点击区分（3px 阈值）
2. 实现左右边缘自动吸附功能（20px 吸附阈值）
3. 实现停靠后自动半隐藏功能（400ms 延迟，50% 隐藏比例）
4. 实现智能面板定位，根据按钮位置自动选择最佳展开方向
5. 实现状态持久化，保存/恢复按钮位置、停靠状态、用户偏好
6. 实现窗口大小变化时的自适应处理
7. 提供用户控制菜单，支持重置位置、切换设置等功能
8. 保持与现有代码的向后兼容性

**Non-Goals:**
- 不支持上下边缘吸附（仅左右边缘）
- 不实现多按钮管理或按钮主题定制
- 不修改现有的文件下载核心逻辑
- 不添加新的第三方依赖库
- 不实现动画效果的自定义配置界面

## Decisions

### 1. 使用基于 transform 的半隐藏效果
**决策：** 使用 `transform: translateX()` 实现半隐藏效果，而非调整 `left/right` 属性。

**理由：**
- 性能更好，transform 不会触发重排（reflow）
- 可以保持 `left` 或 `right` 的停靠状态不变
- 动画更流畅，配合 `transition` 属性实现平滑效果

**替代方案：** 直接修改 `left`/`right` 值，但会导致频繁的布局计算。

### 2. 使用状态机管理拖拽和停靠状态
**决策：** 使用集中式的 `state` 对象管理所有交互状态（isDragging, hasDragged, docked, hidden 等）。

**理由：**
- 状态关系清晰，便于调试和维护
- 避免分散的状态变量导致的竞态条件
- 与 saveState/loadState 配合实现持久化

**替代方案：** 分散的布尔变量，但容易导致状态不一致。

### 3. 拖拽与点击使用位移阈值区分
**决策：** 使用 3px 的位移阈值区分拖拽和点击操作。

**理由：**
- 3px 足以过滤掉手抖或轻微移动
- 不会显著影响点击响应速度
- 实现简单，不需要时间阈值

**替代方案：** 使用时间阈值（如 200ms），但会让点击有延迟感。

### 4. 面板定位采用四象限算法
**决策：** 将屏幕分为四象限，根据按钮所在象限和空间可用性选择面板展开方向。

**理由：**
- 逻辑清晰，易于理解和维护
- 能确保面板在可视区域内
- 自动适应不同屏幕尺寸和按钮位置

**算法：**
1. 计算按钮中心相对于视口中心的位置（左/右半区，上/下半区）
2. 计算四个方向可用空间
3. 优先选择与象限一致的方向，空间不足时回退到相反方向

### 5. 延迟重置 hasDragged 标志
**决策：** 在 mouseup 事件中使用 setTimeout(..., 0) 延迟重置 hasDragged 标志。

**理由：**
- 确保 click 事件处理时 hasDragged 仍为 true
- 阻止拖拽结束后的 click 事件误触面板
- 不干扰正常的点击流程

### 6. 使用 GM_registerMenuCommand 而非自定义 UI
**决策：** 使用 Tampermonkey 原生菜单命令提供用户控制，而非在页面内添加设置界面。

**理由：**
- 实现简单，无需额外的 UI 代码
- 符合用户脚本的使用习惯
- 不影响页面原有 UI
- 支持热键操作（部分脚本管理器）

## Risks / Trade-offs

### [Risk] GM API 在某些脚本管理器中不可用
**影响：** 如果用户的脚本管理器不支持 GM_setValue/GM_getValue/GM_registerMenuCommand，状态持久化和菜单功能将失效。

**Mitigation：**
- 在初始化时检查 API 可用性， gracefully degrade
- 如果 API 不可用，仍保留拖拽和吸附功能，但不保存状态
- 在控制台输出警告信息

### [Risk] 与页面原有事件冲突
**影响：** 如果 GitHub 页面或其他脚本也监听 mousemove/mouseup 事件，可能产生冲突。

**Mitigation：**
- 使用事件委托模式，在 document 级别监听事件
- 在事件处理函数中合理使用 preventDefault 和 stopPropagation
- 使用 CSS 属性 `user-select: none` 防止拖拽时选中文本

### [Risk] 拖拽过程中的性能问题
**影响：** mousemove 事件触发频繁，如果处理逻辑复杂可能导致卡顿。

**Mitigation：**
- 保持 mousemove 处理逻辑轻量
- 仅更新位置，不做复杂的 DOM 操作或计算
- 使用 transform 而非修改布局属性
- 面板位置更新仅在面板打开时进行

### [Risk] 状态存储过大或格式变更
**影响：** 如果未来需要存储更多状态，可能超出存储限制或与旧版本不兼容。

**Mitigation：**
- 使用结构化的 JSON 对象存储，便于版本管理
- 在 loadState 中处理解析错误，失败时使用默认值
- 存储的数据量很小（仅位置、布尔值等），不会超出限制

### [Trade-off] 自动隐藏可能影响部分用户的可发现性
**影响：** 新用户可能找不到隐藏的按钮。

**理由：**
- 这是有意为之的设计，减少视觉干扰是主要目标
- 鼠标滑过边缘区域即可发现按钮
- 提供 GM_registerMenuCommand 快速重置位置

## Migration Plan

**部署步骤：**
1. 更新脚本文件，添加新的 CONFIG、state 定义和函数
2. 在 Tampermonkey 元数据中添加 `@grant GM_setValue`、`@grant GM_getValue`、`@grant GM_registerMenuCommand`
3. 修改 createControlPanel() 函数，添加事件绑定和样式更新
4. 修改 init() 函数，添加状态加载和菜单注册
5. 测试所有功能场景

**向后兼容：**
- 首次安装或升级后，没有保存的状态，使用默认位置（右下角）
- 现有功能（文件下载）不受影响
- 用户可以立即使用拖拽移动按钮

**回滚策略：**
- 如需回滚，恢复旧版本脚本即可
- 存储的状态不会影响旧版本（旧版本不读取该存储键）
- 使用 `🗑️ 清除状态存储` 菜单项可以清理所有保存的状态

## Open Questions

1. **吸附阈值是否需要可配置？**
   - 当前使用固定的 20px 阈值，是否需要通过菜单命令调整？
   - 建议：保持固定，20px 是合理的默认值，过多配置会增加复杂性。

2. **是否需要支持触摸设备（移动端）？**
   - 当前仅实现鼠标事件（mousedown/mousemove/mouseup）
   - GitHub 移动端界面不同，该脚本主要针对桌面端
   - 建议：暂不支持，如需支持需额外添加 touch 事件处理

3. **隐藏比例的动画时长是否需要可配置？**
   - 当前使用固定的 200ms 动画时长
   - 建议：保持固定，用户可通过 CSS 覆盖或使用菜单命令禁用自动隐藏

4. **是否需要添加按钮位置的记忆学习功能？**
   - 例如：自动记住用户最常用的位置
   - 建议：不需要，显式的拖拽操作已足够表达用户意图

